<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>WASM 图片转换测试</title>
</head>
<body>
<h2>WASM 图片转换测试</h2>

<input type="file" id="fileInput" accept="image/*"/><br><br>
<button id="btnICNS">生成 ICNS</button>
<button id="btnICO">生成 ICO</button>
<button id="btnPNGs">生成 PNGs</button>
<button id="btnBoth">生成 ICNS + ICO + PNG</button>

<pre id="log"></pre>

<script type="module">
    import createModule from "./fun.js";
    let Module, inputFile=null;
    const log=msg=>document.getElementById("log").textContent+=msg+"\n";

    async function init(){ Module=await createModule(); log("✅ WASM 已加载"); }
    init();

    document.getElementById("fileInput").addEventListener("change", async e=>{
        const file=e.target.files[0];
        if(!file) return;
        inputFile="/input.png";
        const buf=new Uint8Array(await file.arrayBuffer());
        Module.FS_writeFile(inputFile,buf);
        log(`📂 写入虚拟文件系统: ${inputFile} (${buf.length} bytes)`);
    });

    document.getElementById("btnICNS").addEventListener("click",()=>run("wasm_convert_to_icns"));
    document.getElementById("btnICO").addEventListener("click",()=>run("wasm_convert_to_ico"));
    document.getElementById("btnPNGs").addEventListener("click",()=>run("wasm_convert_to_pngs"));
    document.getElementById("btnBoth").addEventListener("click",()=>run("wasm_convert_to_both"));

    async function run(funcName){
        if(!inputFile){ log("❌ 请先选择文件"); return; }

        const sizes=[16,32,48,64,128,256,512,1024];

        switch(funcName){
            case "wasm_convert_to_icns":{
                const out="/output.icns";
                const r=Module.ccall(funcName,"number",["string","string"],[inputFile,out]);
                log(`调用 ${funcName} 返回: ${r}`);
                if(r===0) download(out,"output.icns");
                break;
            }
            case "wasm_convert_to_ico":{
                const out="/output.ico";
                const r=Module.ccall(funcName,"number",["string","string"],[inputFile,out]);
                log(`调用 ${funcName} 返回: ${r}`);
                if(r===0) download(out,"output.ico");
                break;
            }
            case "wasm_convert_to_pngs":{
                const r=Module.ccall(funcName,"number",["string"],[inputFile]);
                log(`调用 ${funcName} 返回: ${r}`);
                for(const s of sizes){
                    const fname=`/${s}.png`;
                    try{
                        const data=Module.FS_readFile(fname);
                        download(fname,`${s}.png`,data);
                    }catch(e){ log(`❌ 缺少 ${fname}`); }
                }
                break;
            }
            case "wasm_convert_to_both":{
                const r=Module.ccall(funcName,"number",["string","string"],[inputFile,"/output_both"]);
                log(`调用 ${funcName} 返回: ${r}`);
                try{ download("/output_both.icns","output_both.icns"); }catch{}
                try{ download("/output_both.ico","output_both.ico"); }catch{}
                for(const s of sizes){
                    const fname=`/${s}.png`;
                    try{ const data=Module.FS_readFile(fname); download(fname,`${s}.png`,data);}catch{}
                }
                break;
            }
        }
    }

    function download(path,filename,data){
        if(!data) data=Module.FS_readFile(path);
        const blob=new Blob([data]);
        const a=document.createElement("a");
        a.href=URL.createObjectURL(blob);
        a.download=filename;
        a.click();
    }
</script>
</body>
</html>
