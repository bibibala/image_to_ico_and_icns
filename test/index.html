<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>WASM å›¾ç‰‡è½¬æ¢æµ‹è¯•</title>
</head>
<body>
<h2>WASM å›¾ç‰‡è½¬æ¢æµ‹è¯•</h2>

<input type="file" id="fileInput" accept="image/*"/><br><br>
<button id="btnICNS">ç”Ÿæˆ ICNS</button>
<button id="btnICO">ç”Ÿæˆ ICO</button>
<button id="btnPNGs">ç”Ÿæˆ PNGs</button>
<button id="btnBoth">ç”Ÿæˆ ICNS + ICO + PNG</button>

<pre id="log"></pre>

<script type="module">
import createModule from "../output/fun.js";
let Module, inputFile=null;
const log=msg=>document.getElementById("log").textContent+=msg+"\n";

async function init(){ Module=await createModule(); log("âœ… WASM å·²åŠ è½½"); }
init();

document.getElementById("fileInput").addEventListener("change", async e=>{
    const file=e.target.files[0];
    if(!file) return;
    inputFile="/input.png";
    const buf=new Uint8Array(await file.arrayBuffer());
    Module.FS_writeFile(inputFile,buf);
    log(`ğŸ“‚ å†™å…¥è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ: ${inputFile} (${buf.length} bytes)`);
});

document.getElementById("btnICNS").addEventListener("click",()=>run("wasm_convert_to_icns"));
document.getElementById("btnICO").addEventListener("click",()=>run("wasm_convert_to_ico"));
document.getElementById("btnPNGs").addEventListener("click",()=>run("wasm_convert_to_pngs"));
document.getElementById("btnBoth").addEventListener("click",()=>run("wasm_convert_to_both"));

async function run(funcName){
    if(!inputFile){ log("âŒ è¯·å…ˆé€‰æ‹©æ–‡ä»¶"); return; }

    // æ›´æ–°å°ºå¯¸æ•°ç»„ï¼ŒåŒ…å«æ–°å¢çš„å°ºå¯¸
    const sizes=[16,24,30,32,40,48,64,72,80,96,128,256,512,1024];

    switch(funcName){
        case "wasm_convert_to_icns":{
            const out="/output.icns";
            const r=Module.ccall(funcName,"number",["string","string"],[inputFile,out]);
            log(`è°ƒç”¨ ${funcName} è¿”å›: ${r}`);
            if(r===0) download(out,"output.icns");
            break;
        }
        case "wasm_convert_to_ico":{
            const out="/output.ico";
            const r=Module.ccall(funcName,"number",["string","string"],[inputFile,out]);
            log(`è°ƒç”¨ ${funcName} è¿”å›: ${r}`);
            if(r===0) download(out,"output.ico");
            break;
        }
        case "wasm_convert_to_pngs":{
            const r=Module.ccall(funcName,"number",["string"],[inputFile]);
            log(`è°ƒç”¨ ${funcName} è¿”å›: ${r}`);
            let downloadCount = 0;
            for(let i = 0; i < sizes.length; i++){
                const s = sizes[i];
                const fname=`/${s}.png`;
                try{
                    const data=Module.FS_readFile(fname);
                    // æ·»åŠ å»¶è¿Ÿé¿å…æµè§ˆå™¨é™åˆ¶ä¸‹è½½
                    setTimeout(() => {
                        download(fname,`${s}.png`,data);
                        log(`âœ… ä¸‹è½½ ${s}.png (${data.length} bytes)`);
                    }, i * 300); // æ¯ä¸ªæ–‡ä»¶å»¶è¿Ÿ300msä¸‹è½½
                    downloadCount++;
                }catch(e){
                    log(`âŒ ç¼ºå°‘ ${fname}: ${e.message}`);
                }
            }
            log(`ğŸ“Š æ€»è®¡å‡†å¤‡ä¸‹è½½ ${downloadCount}/${sizes.length} ä¸ª PNG æ–‡ä»¶`);
            break;
        }
        case "wasm_convert_to_both":{
            const r=Module.ccall(funcName,"number",["string","string"],[inputFile,"/output_both"]);
            log(`è°ƒç”¨ ${funcName} è¿”å›: ${r}`);

            // å…ˆä¸‹è½½ICNSå’ŒICO
            try{
                download("/output_both.icns","output_both.icns");
                log("âœ… ä¸‹è½½ ICNS æ–‡ä»¶");
            }catch{
                log("âŒ ICNS æ–‡ä»¶ä¸‹è½½å¤±è´¥");
            }

            setTimeout(() => {
                try{
                    download("/output_both.ico","output_both.ico");
                    log("âœ… ä¸‹è½½ ICO æ–‡ä»¶");
                }catch{
                    log("âŒ ICO æ–‡ä»¶ä¸‹è½½å¤±è´¥");
                }
            }, 500);

            // ç„¶åä¸‹è½½PNGæ–‡ä»¶ï¼Œæ·»åŠ å»¶è¿Ÿ
            let downloadCount = 0;
            for(let i = 0; i < sizes.length; i++){
                const s = sizes[i];
                const fname=`/${s}.png`;
                try{
                    const data=Module.FS_readFile(fname);
                    setTimeout(() => {
                        download(fname,`${s}.png`,data);
                        log(`âœ… ä¸‹è½½ ${s}.png (${data.length} bytes)`);
                    }, 1000 + i * 300); // ä»1ç§’åå¼€å§‹ï¼Œæ¯ä¸ªæ–‡ä»¶å»¶è¿Ÿ300ms
                    downloadCount++;
                }catch{
                    log(`âŒ ç¼ºå°‘ ${s}.png`);
                }
            }
            log(`ğŸ“Š æ€»è®¡å‡†å¤‡ä¸‹è½½ ${downloadCount}/${sizes.length} ä¸ª PNG æ–‡ä»¶`);
            break;
        }
    }
}

function download(path,filename,data){
    if(!data) data=Module.FS_readFile(path);
    const blob=new Blob([data]);
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=filename;
    a.click();
}
</script>
</body>
</html>
